rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ユーザー情報
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      // ユーザーのいいねサブコレクション
      match /likes/{postId} {
        allow read: if request.auth != null && request.auth.uid == userId;

        // 作成：自分のいいねのみ、postId と createdAt のみ許可
        allow create: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.keys().hasOnly(['postId', 'createdAt'])
                      && request.resource.data.postId == postId
                      && request.resource.data.createdAt is timestamp;

        // 削除：自分のいいねのみ
        allow delete: if request.auth != null
                      && request.auth.uid == userId;
      }
    }

    // 投稿
    match /posts/{postId} {
      // ゲストも閲覧可能に変更
      allow read: if request.auth != null ;

      // 投稿作成
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'regionId', 'seasonId', 'caption', 'location']);

      // 投稿の更新：投稿者本人の編集 OR いいねによるlikesCount/scoreの更新
      allow update: if request.auth != null && (
        // 投稿者本人による編集
        (resource.data.userId == request.auth.uid)
        ||
        // いいねによるlikesCount/scoreの更新のみ許可
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likesCount', 'score'])
         && request.resource.data.userId == resource.data.userId)
      );

      // 投稿者本人のみ削除
      allow delete: if request.auth != null 
                    && resource.data.userId == request.auth.uid;

      // likesサブコレクション
      match /likes/{userId} {
        allow read: if request.auth != null;

        // 作成：自分のUIDのみ、userId と createdAt のみ許可
        allow create: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.keys().hasOnly(['userId', 'createdAt'])
                      && request.resource.data.userId == request.auth.uid
                      && request.resource.data.createdAt is timestamp;

        // 削除：自分の like のみ
        allow delete: if request.auth != null
                      && request.auth.uid == userId;
      }
    }

    // シーズン
    match /seasons/{seasonId} {
      allow read: if true;
      allow write: if false;

      match /regionTop/{regionId} {
        // ゲストも閲覧可能に変更
        allow read: if true;
        allow write: if false;
      }
    }

    // 地域
    match /regions/{regionId} {
      allow read: if true;
      allow write: if false;
    }

    // fallback
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
